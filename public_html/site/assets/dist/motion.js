!function(t){"use strict";function e(){this._head=null,this._tail=null,this._length=0}e.prototype._createNewNode=function(t){var e=this;return{data:t,next:null,prev:null,remove:function(){null!==this.prev&&(this.prev.next=this.next),null!==this.next&&(this.next.prev=this.prev),e._head===this&&(e._head=this.next),e._tail===this&&(e._tail=this.prev),e._length--},prepend:function(t){if(e._head===this)return e.prepend(t);var n=e._createNewNode(t);return n.prev=this.prev,n.next=this,this.prev.next=n,this.prev=n,e._length++,n},append:function(t){if(e._tail===this)return e.append(t);var n=e._createNewNode(t);return n.prev=this,n.next=this.next,this.next.prev=n,this.next=n,e._length++,n}}},e.prototype.append=function(t){var e=this._createNewNode(t);return 0===this._length?(this._head=e,this._tail=e):(this._tail.next=e,e.prev=this._tail,this._tail=e),this._length++,e},e.prototype.prepend=function(t){var e=this._createNewNode(t);return null===this._head?this.append(t):(this._head.prev=e,e.next=this._head,this._head=e,this._length++,e)},e.prototype.item=function(t){if(t>=0&&t<this._length){for(var e=this._head;t--;)e=e.next;return e}},e.prototype.head=function(){return this._head},e.prototype.tail=function(){return this._tail},e.prototype.size=function(){return this._length},e.prototype.remove=function(t){throw"Not implemented"},t.DoublyLinkedList=e}("undefined"==typeof exports?this.DLL={}:exports);
"use strict";var _createClass=function(){function t(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e}}();function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var Rect=function(){function t(e,i){_classCallCheck(this,t),this.width=e,this.height=i,this.ratio=e/i}return _createClass(t,[{key:"contain",value:function(e){var i={};return e.ratio>this.ratio?(i.width=this.width,i.height=Math.round(this.width/e.ratio)):(i.width=Math.round(this.height*e.ratio),i.height=this.height),t.createFromObject(i)}},{key:"containBigger",value:function(t){var e=this.contain(t);return e.width>t.width||e.height>t.height?t:e}}]),t}();Rect.createFromNode=function(t){return new Rect(t.offsetWidth,t.offsetHeight)},Rect.createFromObject=function(t){return new Rect(t.width,t.height)};"use strict";var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var AjaxLoader=function(){function e(t){_classCallCheck(this,e),this.baseUrl=t,this.isBusy=!1}return _createClass(e,[{key:"fetch",value:function(){return this.isBusy?Promise.reject("Must wait for the current page to finish."):(this.isBusy=!0,window.fetch(this.getUrl()).then(this.onResponse.bind(this)))}},{key:"getUrl",value:function(){throw new Error("Method must be implemented by a subclass.")}},{key:"onResponse",value:function(e){return e.json()}},{key:"done",value:function(){this.isBusy=!1}},{key:"content",value:function(){return this.fetch()}}]),e}();"use strict";var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var ImageLoader=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n.images=e,n.chunkSize=5,n.parallelCount=0,n.loadedImages=[],n.isLoadingAll=!1,n}return _inherits(t,EventEmitter),_createClass(t,[{key:"loadAll",value:function(){var e=this;return this.isLoadingAll=!0,new Promise(function(t,n){e.loadChunk(t)}).then(function(t){return e.trigger("all")})}},{key:"loadChunk",value:function(e){var t=this.loadedImages.length,n=t+this.chunkSize,a=this.images.length;return Promise.all(_.range(t,Math.min(n,a)).map(this.loadIndex.bind(this))).then(this.onChunkLoaded.bind(this,e))}},{key:"onChunkLoaded",value:function(e){return this.trigger("chunkloaded"),this.loadedImages.length==this.images.length?(e(this.loadedImages.length),this.isLoadingAll=!1):this.isLoadingAll&&this.loadChunk(e),this.loadedImages.length}},{key:"onImageLoaded",value:function(e,t){return this.loadedImages.push(e),this.parallelCount--,this.trigger("imageloaded",{image:t,index:e}),e}},{key:"loadImage",value:function(e){return this.parallelCount>=t.MAX_PARALLEL_COUNT?Promise.reject(new Error("Cannot exceed "+t.MAX_PARALLEL_COUNT+" simultaneous loads.")):(this.parallelCount++,new Promise(function(t,n){var a=new Image;a.addEventListener("load",function e(){a.removeEventListener("load",e),t(a)}),a.src=e}))}},{key:"loadIndex",value:function(e){return this.loadedImages.includes(e)?Promise.reject(new Error("Image ["+e+"]"+this.images[e]+" was already loaded.")):this.loadImage(this.images[e]).then(_.bindKey(this,"onImageLoaded",e))}}]),t}();ImageLoader.MAX_PARALLEL_COUNT=5;"use strict";var _createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var a=t[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,i,a){return i&&e(t.prototype,i),a&&e(t,a),t}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var Motion=function(e){function t(e){_classCallCheck(this,t);var i=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));i.node=e,e.id=e.dataset.name.split("/").join("--");var a=e.dataset;return i._slideshowInfo=window[e.dataset.name],i.imageCount=i._slideshowInfo.length,i.poster=e.querySelector("img"),i.isInitialized=!1,i.hasBufferLoaded=!1,i.hasStarted=!1,i.autoplay="autoplay"in a&&"true"==a.autoplay,i.baseUrl="http://dahlenstudio.com"+window.app.config.ALBUMS_URL+a.name,i.animation=new MotionAnimation(t.ANIMATION_EVENT_NAMES),e.addEventListener("click",i.onClick.bind(i)),i}return _inherits(t,EventEmitter),_createClass(t,[{key:"setupImageCreate",value:function(){var e=parseInt(this.node.dataset.timing,10);this.createImage=t.prototype.createImage.bind(this,{delay:e,duration:e+50,fadeDuration:e+50},Rect.createFromNode(this.node))}},{key:"onPlayButtonClick",value:function(){this.isInitialized||this.init(),this.when("buffered").then(this.play.bind(this))}},{key:"onClick",value:function(e){return e.target.classList.contains("play-button")?this.onPlayButtonClick():this.node.classList.contains("playing")?this.togglePlay():void 0}},{key:"onBufferLoaded",value:function(){this.hasBufferLoaded=!0,this.node.classList.add("buffered"),this.trigger("buffered")}},{key:"onImageLoaded",value:function(e,t){!this.hasBufferLoaded&&t/this.imageCount>window.app.config.MOTION_BUFFER_SIZE&&this.onBufferLoaded()}},{key:"onImagesLoaded",value:function(){this.node.classList.remove("loading"),this.trigger("loaded")}},{key:"loadImages",value:function(){var e=this,t=new ImageLoader(this._slideshowInfo.map(function(t){return e.baseUrl+"/"+t.filename}));return t.events.addEventListener("imageloaded",function(t){return e.onImageLoaded(t.detail.image,t.detail.index)}),this.node.classList.add("loading"),t.loadAll().then(_.bindKey(this,"onImagesLoaded"))}},{key:"finish",value:function(){this.node.classList.add("finished"),this.node.classList.remove("playing"),this.trigger("finished")}},{key:"play",value:function(){this.hasStarted||(this.hasStarted=!0,this.node.classList.add("playing"),this.trigger("started"),app.music.play(this.node.dataset.name),this.resume())}},{key:"pause",value:function(){this.trigger("paused"),this.animation.pause()}},{key:"resume",value:function(){this.trigger("resumed"),this.animation.resume()}},{key:"togglePlay",value:function(){return this.animation.isPaused?this.resume():this.pause()}},{key:"remove",value:function(){var e=this;return requestAnimationFrame(function(){return e.node.style.opacity=0}),Promise.delay(t.CONTAINER_FADE_DURATION,function(){return e.node.classList.add("removed")})}},{key:"addImageKeyFrames",value:function(e,t){if(0==t)this.animation.addKeyFrame("hide",e.delay+e.duration,t),this.animation.addKeyFrame("remove",e.delay+e.fadeOutDuration,t);else{var i=e.delay,a=i+e.fadeInDuration+e.duration,n=a+e.fadeOutDuration;this.animation.addKeyFrame("show",i,t),this.animation.addKeyFrame("hide",a,t),this.animation.addKeyFrame("remove",n,t)}}},{key:"createImage",value:function(e,t,i){var a=this._slideshowInfo[i],n=new MotionImage(this.baseUrl+"/"+a.filename);this.images[i]=n,n.parseInfo(e,t,a,i,i?this.images[i-1]:void 0),0==i&&(n.createImageNode(),this.poster.style.cssText=n.node.getAttribute("style"),n.node=this.poster),this.addImageKeyFrames(n,i)}},{key:"onShowAnimationTick",value:function(e){var t=e.detail.value;this.images[t].show(this.node)}},{key:"onHideAnimationTick",value:function(e){var t=e.detail.value;t<this.imageCount-1&&this.images[t].hide()}},{key:"onRemoveAnimationTick",value:function(e){var t=e.detail.value;t===this.imageCount-1?this.finish():(this.images[t].remove(),delete this.images[t],delete this._slideshowInfo[t])}},{key:"init",value:function(){if(!this.isInitialized){var e=!0,i=!1,a=void 0;try{for(var n,o=t.ANIMATION_EVENT_NAMES[Symbol.iterator]();!(e=(n=o.next()).done);e=!0){var s=n.value,r="on"+_.capitalize(s)+"AnimationTick";this.animation.on(s,_.bindKey(this,r))}}catch(e){i=!0,a=e}finally{try{!e&&o.return&&o.return()}finally{if(i)throw a}}this.isInitialized=!0,this.totalDelay=0,this.images=[],this.loadImages(),this.setupImageCreate();for(var d=0;d<this._slideshowInfo.length;d++)this.createImage(d)}}}]),t}();Motion.ANIMATION_EVENT_NAMES=["show","hide","remove"],Motion.CONTAINER_FADE_DURATION=4e3,Motion.LAST_IMAGE_DELAY=1e3,Motion.AUTOPLAY_DELAY=500;"use strict";var _createClass=function(){function e(e,t){for(var a=0;a<t.length;a++){var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,a,n){return a&&e(t.prototype,a),n&&e(t,n),t}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var MotionImage=function(){function e(t){_classCallCheck(this,e),this.url=t,this.hasLoaded=!1}return _createClass(e,[{key:"parseInfo",value:function(t,a,n,i,o){var r=e.INITIAL_DURATIONS;if("position"in n&&(this.left=n.position[0],this.top=n.position[1]),"width"in n){var u=a.containBigger(Rect.createFromObject(n));_.assign(this,u)}"fade"in n?(this.fadeInDuration=n.fade[0]?n.fade[0]:t.fadeDuration,this.fadeOutDuration=n.fade[1]?n.fade[1]:t.fadeDuration):this.fadeInDuration=this.fadeOutDuration=t.fadeDuration,this.duration="duration"in n?n.duration?n.duration:t.duration:i<r.length?r[i]:t.duration,this.delay="delay"in n?n.delay?n.delay:o.delay+t.delay:i<r.length-1?r[i+1]-100:o.delay+t.delay}},{key:"createImageNode",value:function(){var e=new Image,t=e.style;e.src=this.url;for(var a=["left","top","width","height"],n=0;n<a.length;n++){var i=a[n];i in this&&(t[i]=this[i]+"px")}"left"in this&&(t.margin=0),this.node=e}},{key:"fade",value:function(e,t){var a=this.node.style;a.transition="opacity "+t+"ms",requestAnimationFrame(function(){return a.opacity=e})}},{key:"fadeIn",value:function(){this.fade(1,this.fadeInDuration)}},{key:"fadeOut",value:function(){this.fade(0,this.fadeOutDuration)}},{key:"show",value:function(e){this.createImageNode(),e.appendChild(this.node),this.fadeIn()}},{key:"hide",value:function(){this.fadeOut()}},{key:"remove",value:function(){this.node.remove()}}]),e}();MotionImage.INITIAL_DURATIONS=[1e3,700,500,400];"use strict";var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var MotionQueue=function(){function e(t){_classCallCheck(this,e),this.list=new DLL.DoublyLinkedList;for(var n=0,a=t.length;n<a;n++){var s=t[n];s.node.style.zIndex=a-n,this.list.append(s)}}return _createClass(e,[{key:"setupRelays",value:function(){for(var e=this.list.head();e.next;){var t=e.data,n=e.next.data;this.setupRelay(t,n),e=e.next}}},{key:"setupRelay",value:function(e,t){this.whenFinished(e,t).then(this.start.bind(this,t))}},{key:"start",value:function(e){return this.startItem(void 0===e?this.list.head().data:e)}},{key:"startItem",value:function(e){throw new Error("Method must be implemented by a subclass.")}},{key:"whenFinished",value:function(e,t){throw new Error("Method must be implemented by a subclass.")}},{key:"clone",value:function(e){for(var t=[],n=0,a=this.list.size();n<a;n++)t.push(this.list.item(n).data);return e(t)}}]),e}();"use strict";var _createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var MotionAnimation=function(e){function t(e){_classCallCheck(this,t);var i=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));i.keyFrames={};var r=!0,n=!1,s=void 0;try{for(var a,o=e[Symbol.iterator]();!(r=(a=o.next()).done);r=!0){var u=a.value;i.keyFrames[u]=[]}}catch(e){n=!0,s=e}finally{try{!r&&o.return&&o.return()}finally{if(n)throw s}}return i.timeElapsed=0,i.isPaused=!0,i}return _inherits(t,EventEmitter),_createClass(t,[{key:"addKeyFrame",value:function(e,t,i){this.keyFrames[e].push({time:t,value:i})}},{key:"hasKeyFrames",value:function(){var e=this,t=Object.keys(this.keyFrames),i=t.length&&t.some(function(t){return e.keyFrames[t].length});return i}},{key:"onTick",value:function(){var e=this,t=Date.now();for(var i in this.timeElapsed+=t-this.tickTime,this.keyFrames){var r=_.findIndex(this.keyFrames[i],function(t){return t.time<e.timeElapsed});if(r>=0){var n=this.keyFrames[i].splice(r,1).shift();this.trigger(i,n),0==this.keyFrames[i].length&&delete this.keyFrames[i],this.hasKeyFrames()||this.pause()}}this.tickTime=t,this.isPaused||this.tick()}},{key:"pause",value:function(){this.isPaused=!0}},{key:"tick",value:function(){requestAnimationFrame(this.onTick.bind(this))}},{key:"resume",value:function(){if(!this.isPaused)return!1;this.tickTime=Date.now(),this.isPaused=!1,this.tick()}}]),t}();"use strict";var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var MotionLoadingQueue=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return _inherits(t,MotionQueue),_createClass(t,[{key:"startItem",value:function(e){return e.init(),Promise.resolve(!0)}},{key:"whenFinished",value:function(e,t){return new Promise(function(t){return e.on("loaded",t)})}}]),t}();"use strict";var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var MotionPlayingQueue=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return _inherits(t,MotionQueue),_createClass(t,[{key:"startItem",value:function(e){return e.node.style.opacity=1,Promise.delay(t.TRANSITION_DELAY,_.bindKey(e,"onPlayButtonClick"))}},{key:"whenFinished",value:function(e,t){return Promise.all([e.when("finished").then(_.bindKey(e,"remove")),t.when("buffered")])}}]),t}();MotionPlayingQueue.TRANSITION_DELAY=1e3;"use strict";!function(e,n){n.init(function(){var e=Array.from(document.querySelectorAll(".motion")).map(function(e){return new Motion(e)});n.loadingQueue=new MotionLoadingQueue(e),n.loadingQueue.setupRelays(),n.loadingQueue.start()})}(jQuery,window.app);